# 🔧 مشکلات برطرف شده - قیمت‌ها و نمودارها

## تاریخ: اکتبر 2024

---

## ✅ مشکلات برطرف شده:

### 1️⃣ قیمت‌های تومانی صحیح نیستند (FIXED ✅)

**مشکل**: 
- قیمت‌ها در صفحه اصلی بسیار پایین نمایش داده می‌شدند
- قیمت تومانی با تقسیم بر 10 محاسبه می‌شد که اشتباه بود

**راه‌حل**:
- کد محاسبه قیمت تومانی تصحیح شد
- قبل: `$price_irr = ($price_usd * $usdt_rate) / 10;`
- بعد: `$price_irr = $price_usd * $usdt_rate;`
- استفاده از تابع `crypto_sekhyab_get_usdt_price()` برای دریافت نرخ لحظه‌ای تتر

**فایل تغییر یافته**: `/app/front-page.php`

---

### 2️⃣ نمودارهای 7 روزه فیک بودند (FIXED ✅)

**مشکل**: 
- نمودارهای کوچک 7 روزه در جدول صفحه اصلی به صورت ثابت و فیک بودند
- همه نمودارها یک شکل بودند

**راه‌حل**:
- نمودارها حالا از داده‌های واقعی `sparkline_in_7d` API CoinGecko استفاده می‌کنند
- هر نمودار منحصر به فرد و بر اساس قیمت واقعی 7 روز اخیر رسم می‌شود
- نرمال‌سازی اتوماتیک داده‌ها برای نمایش بهتر
- رنگ نمودار بر اساس تغییرات (سبز برای صعودی، قرمز برای نزولی)

**فایل تغییر یافته**: `/app/front-page.php`

---

### 3️⃣ نرخ تبدیل تتر/دلار به تومان (VERIFIED ✅)

**وضعیت**: سیستم دریافت نرخ تتر از 3 منبع مختلف کار می‌کند:

1. **منبع اصلی**: Nobitex API (`https://api.nobitex.ir/market/stats`)
2. **منبع دوم**: Tetherland API (`https://api.tetherland.com/currencies`)
3. **منبع سوم**: CoinGecko API

**کش**: نرخ تتر برای 10 ثانیه کش می‌شود تا سرعت بالا باشد

**فایل**: `/app/inc/api-handler.php`

---

### 4️⃣ نمودارهای TradingView (VERIFIED ✅)

**وضعیت**: نمودارهای TradingView به درستی کار می‌کنند

**ویژگی‌ها**:
- استفاده خودکار از نماد Binance (مثلاً `BINANCE:BTCUSDT`)
- امکان تغییر تایم‌فریم (1H, 4H, 1D, 1W, 1M)
- نمودارهای تکنیکال کامل با اندیکاتورها
- لوکال فارسی

**نکته**: اگر نماد TradingView در متا فیلد `_crypto_tradingview_symbol` تنظیم نشده باشد، به صورت خودکار از symbol ارز استفاده می‌کند.

**فایل**: `/app/single-cryptocurrency.php`

---

## 📊 اخبار مرتبط با هر ارز

### نحوه کار سیستم اخبار:

سیستم اخبار از 4 سطح جستجو برای پیدا کردن اخبار مرتبط استفاده می‌کند:

#### سطح 1: متا فیلدهای اختصاصی
- `_crypto_news_category`: اسلاگ دسته‌بندی اختصاصی
- `_crypto_news_tag`: اسلاگ تگ اختصاصی

#### سطح 2: جستجو در دسته‌بندی‌ها و تگ‌ها
- جستجو با symbol ارز (مثلاً `btc`, `eth`)
- جستجو با نام ارز (مثلاً `bitcoin`, `ethereum`)

#### سطح 3: جستجو در محتوا
- جستجو در عنوان و محتوای پست‌ها با نام ارز

#### سطح 4: اخبار عمومی
- اگر هیچ خبری پیدا نشد، آخرین اخبار نمایش داده می‌شوند

### نحوه تنظیم اخبار مرتبط:

#### روش 1: تنظیم متا فیلدها (پیشنهادی)

1. به **Cryptocurrencies > ویرایش ارز** بروید
2. در بخش "اطلاعات ارز دیجیتال"، فیلدهای زیر را پیدا کنید:
   - **دسته‌بندی اخبار (Slug)**: مثلاً `bitcoin-news`
   - **برچسب اخبار (Slug)**: مثلاً `btc`
3. این اسلاگ‌ها را وارد کنید
4. ذخیره کنید

#### روش 2: ایجاد دسته‌بندی/تگ مرتبط

1. به **پست‌ها > دسته‌بندی‌ها** بروید
2. دسته‌بندی جدید با اسم و اسلاگ ارز ایجاد کنید:
   - **نام**: "اخبار بیتکوین"
   - **اسلاگ**: `bitcoin` یا `btc`

3. به **پست‌ها > برچسب‌ها** بروید
4. تگ جدید با symbol ارز ایجاد کنید:
   - **نام**: "BTC"
   - **اسلاگ**: `btc`

5. وقتی پست خبری می‌نویسید، آن را به این دسته‌بندی/تگ اضافه کنید

### مثال عملی:

برای **بیتکوین**:

1. **متا فیلدها در صفحه ارز**:
   - دسته‌بندی اخبار: `bitcoin`
   - برچسب اخبار: `btc`

2. **دسته‌بندی وردپرس**:
   - نام: "اخبار بیتکوین"
   - اسلاگ: `bitcoin`

3. **تگ وردپرس**:
   - نام: "BTC"
   - اسلاگ: `btc`

4. **پست‌های خبری**:
   - دسته‌بندی: اخبار بیتکوین
   - یا تگ: BTC

**نتیجه**: تمام پست‌هایی که دسته‌بندی "اخبار بیتکوین" یا تگ "BTC" دارند، در صفحه بیتکوین نمایش داده می‌شوند.

---

## 🐛 رفع مشکلات:

### مشکل: نمودارها نمایش داده نمی‌شوند

**علت**: API CoinGecko ممکن است sparkline را برنگرداند

**راه‌حل**: 
- کش را پاک کنید (از **ابزارها > کش قالب**)
- مطمئن شوید که API CoinGecko در دسترس است
- اگر مشکل ادامه داشت، در کد نمودار پیام "—" نمایش داده می‌شود

### مشکل: قیمت‌های تومانی هنوز اشتباه است

**چک‌لیست**:
1. کش سایت را پاک کنید
2. به **تنظیمات > پیوندهای یکتا** بروید و "ذخیره تغییرات" را بزنید
3. صفحه را با Ctrl+Shift+R رفرش کنید (کش مرورگر پاک می‌شود)
4. بررسی کنید که Nobitex API در دسترس است

### مشکل: اخبار مرتبط نمایش داده نمی‌شوند

**راه‌حل**:
1. مطمئن شوید که حداقل چند پست خبری در وردپرس دارید
2. دسته‌بندی یا تگ مرتبط با ارز ایجاد کنید
3. متا فیلدهای `_crypto_news_category` و `_crypto_news_tag` را تنظیم کنید
4. پست‌های خبری را به دسته‌بندی/تگ مرتبط اضافه کنید

---

## 📁 فایل‌های تغییر یافته:

1. `/app/front-page.php` - قیمت‌های تومانی و نمودارهای واقعی
2. `/app/single-cryptocurrency.php` - اخبار مرتبط و نمودار TradingView
3. `/app/inc/api-handler.php` - دریافت نرخ تتر (بدون تغییر، فقط بررسی شد)
4. `/app/inc/coingecko-api-handler.php` - دریافت sparkline (بدون تغییر، فقط بررسی شد)

---

## ✨ بهبودها:

- ✅ قیمت‌های تومانی صحیح و به‌روز
- ✅ نمودارهای 7 روزه واقعی
- ✅ رنگ‌بندی هوشمند (سبز/قرمز)
- ✅ کش بهینه برای سرعت بالا
- ✅ Fallback برای زمانی که داده در دسترس نیست
- ✅ سیستم جستجوی چندسطحی برای اخبار
- ✅ نمودارهای TradingView تکنیکال

---

**وضعیت**: ✅ همه مشکلات برطرف شدند
**تست شده**: ✅ بله
**آماده استفاده**: ✅ بله
